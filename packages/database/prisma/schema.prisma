// ===========================================
// Underdog AI - Database Schema
// ===========================================
// Owner: Stream 1 (Core Platform)
// All schema changes require Stream 1 review

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// Stream 1: Core Platform
// ===========================================

enum UserRole {
  admin
  trainer
  trainee
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  @@map("organizations")
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  name           String
  role           UserRole     @default(trainee)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id])
  trainingSessions TrainingSession[]
  userProgress     UserProgress[]
  recordings       Recording[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

// ===========================================
// Stream 2: AI Role-Play Engine
// ===========================================

enum SessionType {
  roleplay
  recording_analysis
}

enum SessionStatus {
  active
  completed
  abandoned
}

model TrainingSession {
  id         String        @id @default(cuid())
  userId     String
  type       SessionType
  moduleId   String?
  scenarioId String?
  status     SessionStatus @default(active)
  startedAt  DateTime      @default(now())
  endedAt    DateTime?

  user       User                @relation(fields: [userId], references: [id])
  module     CurriculumModule?   @relation(fields: [moduleId], references: [id])
  scenario   TrainingScenario?   @relation(fields: [scenarioId], references: [id])
  transcript Transcript?
  scores     SessionScores?

  @@index([userId])
  @@index([moduleId])
  @@map("training_sessions")
}

enum Speaker {
  trainee
  ai
  prospect
}

model Transcript {
  id        String   @id @default(cuid())
  sessionId String   @unique
  duration  Float
  createdAt DateTime @default(now())

  session  TrainingSession     @relation(fields: [sessionId], references: [id])
  segments TranscriptSegment[]

  @@map("transcripts")
}

model TranscriptSegment {
  id           String  @id @default(cuid())
  transcriptId String
  speaker      Speaker
  text         String
  startTime    Float
  endTime      Float
  confidence   Float

  transcript Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  @@index([transcriptId])
  @@map("transcript_segments")
}

enum PersonalityType {
  skeptical
  busy
  interested
  hostile
  friendly
}

model AIPersona {
  id               String          @id @default(cuid())
  name             String
  personality      PersonalityType
  moodMin          String          // 'low' | 'medium' | 'high'
  moodMax          String
  objectionStyle   String          // ObjectionCategory
  responsePatterns String[]
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@map("ai_personas")
}

// ===========================================
// Stream 3: Curriculum & Content
// ===========================================

model CurriculumModule {
  id          String   @id @default(cuid())
  number      Int      @unique // 1-12
  title       String
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lessons          Lesson[]
  userProgress     UserProgress[]
  trainingSessions TrainingSession[]
  scenarios        TrainingScenario[]

  @@map("curriculum_modules")
}

model Lesson {
  id        String   @id @default(cuid())
  moduleId  String
  title     String
  content   String   @db.Text
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  module       CurriculumModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  userProgress UserProgress[]

  @@unique([moduleId, order])
  @@index([moduleId])
  @@map("lessons")
}

model UserProgress {
  id          String    @id @default(cuid())
  userId      String
  moduleId    String
  lessonId    String?
  score       Float?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User              @relation(fields: [userId], references: [id])
  module CurriculumModule  @relation(fields: [moduleId], references: [id])
  lesson Lesson?           @relation(fields: [lessonId], references: [id])

  @@unique([userId, moduleId, lessonId])
  @@index([userId])
  @@index([moduleId])
  @@map("user_progress")
}

enum ObjectionCategory {
  common
  industry
  personality
}

model Objection {
  id                 String            @id @default(cuid())
  category           ObjectionCategory
  text               String
  suggestedResponses String[]
  difficulty         Int               @default(3) // 1-5
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([category])
  @@map("objections")
}

model TrainingScenario {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  description String
  personaHint String?  // Suggested persona type
  difficulty  Int      @default(3) // 1-5
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  module           CurriculumModule  @relation(fields: [moduleId], references: [id])
  trainingSessions TrainingSession[]

  @@index([moduleId])
  @@map("training_scenarios")
}

// ===========================================
// Stream 4: Analytics & Feedback
// ===========================================

model SessionScores {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  overallScore      Float
  openingScore      Float
  discoveryScore    Float
  objectionScore    Float
  closingScore      Float
  feedback          String[]
  generatedAt       DateTime @default(now())

  session TrainingSession @relation(fields: [sessionId], references: [id])

  @@map("session_scores")
}

// ===========================================
// Stream 5: Call Recordings
// ===========================================

enum RecordingStatus {
  uploading
  processing
  transcribed
  analyzed
  failed
}

model Recording {
  id           String          @id @default(cuid())
  userId       String
  filename     String
  storageUrl   String
  duration     Float?
  status       RecordingStatus @default(uploading)
  transcriptId String?
  errorMessage String?
  uploadedAt   DateTime        @default(now())
  processedAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("recordings")
}
